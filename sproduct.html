<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Product Details - ECHAD</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">

  <!-- Supabase lib kept (script.js expects window.supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Page layout */
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; background: #fff8fb; color:#2a0a20; margin:0; padding:0; }
    #header { display:flex; align-items:center; justify-content:space-between; padding:18px 28px; background:linear-gradient(180deg,#fff,#fff0f8); }
    #header h4 { margin:0; color:#2a0a20; }
    #navbar { list-style:none; display:flex; gap:12px; align-items:center; margin:0; padding:0; }
    #navbar li a { color:#2a0a20; text-decoration:none; padding:6px 8px; }
    .badge { display:inline-block; min-width:20px; font-size:12px; padding:2px 6px; border-radius:999px; background:#ff9db1; color:#fff; margin-left:6px; }

    /* Container */
    .product-detail-container { max-width:1200px; margin:36px auto; padding:12px; }
    .product-detail {
      display:grid;
      grid-template-columns: 1fr 480px; /* left: info, right: image */
      gap:32px;
      background:transparent;
      backdrop-filter: blur(4px);
      padding:28px;
      border-radius:12px;
      align-items:start;
    }

    /* Left column (info) */
    .product-info h1 { font-size:28px; margin:0 0 8px; color:#2a0a20; }
    .product-price-large { font-size:28px; color:#ff9db1; font-weight:700; margin:12px 0; }
    .product-description { color:#555; line-height:1.6; margin:12px 0 18px; }
    .product-stock { padding:6px 12px; border-radius:8px; display:inline-block; font-weight:700; margin-bottom:10px; }
    .product-stock.in { background:#e8f5e9; color:#2e7d32; }
    .product-stock.out { background:#ffecec; color:#c62828; }

    /* Quantity controls */
    .quantity-selector { display:flex; gap:12px; align-items:center; margin-top:14px; }
    .quantity-controls { display:flex; align-items:center; border:1px solid #f2d9e6; border-radius:8px; overflow:hidden; }
    .quantity-controls button {
      width: 40px;
      height: 40px;
      border: 2px solid #ddd;
      background: white;
      cursor: pointer;
      font-size: 22px;
      color: #000;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    .quantity-controls button:hover {
      border-color: #ff9db1;
    }
    
    .quantity-controls button:active {
      background: #f8f8f8;
      color: #000;
    }
    
    .quantity-controls button:focus {
      outline: none;
      color: #000;
    }

    .quantity-controls button:disabled { opacity:0.5; cursor:not-allowed; }
    .quantity-controls input { width:80px; height:44px; border:0; text-align:center; font-weight:700; font-size:16px; }

    /* Action buttons */
    .action-buttons { display:flex; gap:12px; margin-top:18px; }
    .btn-add-cart { background:#ff9db1; color:#fff; padding:12px 18px; border-radius:10px; border:0; cursor:pointer; font-weight:700; display:inline-flex; align-items:center; gap:8px; }
    .btn-buy-now { background:#333; color:#fff; padding:12px 18px; border-radius:10px; border:0; cursor:pointer; font-weight:700; display:inline-flex; align-items:center; gap:8px; }
    .btn-add-cart[disabled], .btn-buy-now[disabled] { opacity:0.55; cursor:not-allowed; }

    /* Right column (image) */
    .product-image-wrap { background:rgba(255,255,255,0.7); padding:12px; border-radius:12px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.9); }
    .product-image-large { width:100%; height:auto; max-height:640px; object-fit:cover; border-radius:10px; display:block; }

    /* Cart styles kept minimal (cart panel is in script.js CSS) */
    .back-link { display:inline-block; margin-top:18px; color:#ff9db1; text-decoration:none; font-weight:600; }
    .back-link:hover { text-decoration:underline; }

    /* Responsive */
    @media (max-width:960px) {
      .product-detail { grid-template-columns: 1fr; gap:18px; padding:18px; }
      .product-image-wrap { order:-1; } /* image above on mobile */
    }
    .back-link-top {
  display: inline-block;
  color: #ff9db1;
  font-weight: 600;
  text-decoration: none;
  margin-bottom: 15px;
  transition: color 0.2s ease;
}

.back-link-top:hover {
  color: #ff6b93;
  text-decoration: underline;
}

  </style>
</head>
<body>

  <section id="header">
    <h4>ECHAD</h4>
    <div>
      <ul id="navbar">
        <li><a href="index.html">Home</a></li>
        <li><a class="active" href="shop.html">Shop</a></li>
        <li><a href="About.html">About</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li>
          <a href="#" id="cart-toggle-desktop" class="cart-btn" aria-label="Open cart"><i class="fa-solid fa-bag-shopping"></i><span id="cart-badge" class="badge">0</span></a>
        </li>
        <li><button id="openModal">Sign-in/Register</button></li>
      </ul>
    </div>
  </section>

  <div class="product-detail-container">
    <a href="shop.html" class="back-link">← Back to Shop</a>
    <div id="product-loading" style="text-align:center;padding:40px;">
      <i class="fas fa-spinner fa-spin" style="font-size:48px;color:#ff9db1;"></i>
      <p style="margin-top:20px;font-size:18px;color:#666;">Loading product...</p>
    </div>

    <div id="product-detail" style="display:none;"></div>

    <div id="product-error" style="display:none;text-align:center;padding:40px;">
      <i class="fas fa-exclamation-circle" style="font-size:48px;color:#ff9db1;"></i>
      <p style="margin-top:20px;font-size:18px;color:#666;">Product not found</p>
    </div>
  </div>

  <!-- cart panel is present in your site HTML (script.js expects #cart-panel/#cart-backdrop), keep as-is -->
  <aside id="cart-panel" class="cart-panel" aria-hidden="true">
    <div class="cart-header">
      <h3>Your Cart</h3>
      <button id="cart-close" aria-label="Close cart">✕</button>
    </div>
    <div id="cart-items" class="cart-items"></div>
    <div class="cart-footer">
      <div class="cart-totals">
        <div>Subtotal</div>
        <div id="cart-subtotal">—</div>
      </div>
      <div class="cart-actions">
        <button id="checkout" class="accent">Checkout</button>
        <button id="clear-cart" class="secondary">Clear Cart</button>
      </div>
    </div>
  </aside>
  <div id="cart-backdrop" class="cart-backdrop" hidden></div>

  <!-- your main cart/product script -->
  <script src="script.js"></script>

  <!-- page-specific logic -->
  <script>

      // --- Initialize Supabase Client ---

    // ensure the global supabase client is available (without forcing createClient if it's the client already)
  (async function ensureClientForPage(){
    // attempt to use helper defined in script.js
    if (typeof ensureSupabaseClient === 'function') {
      const client = ensureSupabaseClient();
      if (!client) {
        // last resort: try to wait a little for script.js to init it
        for (let i=0;i<6;i++){
          await new Promise(r => setTimeout(r, 150));
          if (typeof ensureSupabaseClient === 'function') {
            const c2 = ensureSupabaseClient();
            if (c2) break;
          }
        }
      }
    }
  })();



    console.log('[SPRODUCT] PAGE LOADED');

        // small helpers
    function escapeHtml(text){ const d=document.createElement('div'); d.textContent = text == null ? '' : String(text); return d.innerHTML; }
    function getProductIdFromURL(){ return new URLSearchParams(window.location.search).get('id'); }

    // wait for the cart functions to exist (but not forever)
    function waitForCartFns(max = 60, interval = 100) {
      return new Promise(resolve => {
        let tries = 0;
        const id = setInterval(() => {
          tries++;
          // functions we may call from script.js
          const ready = (typeof window.addToCartFromSupabase === 'function') ||
                        (typeof window.addToTempCart === 'function');
          const toggleReady = (typeof window.toggleCart === 'function') || (typeof window.openCart === 'function');
          if (ready || tries >= max) {
            clearInterval(id);
            resolve({ ready, toggleReady });
          }
        }, interval);
      });
    }

    async function loadProductDetail() {
      const loading = document.getElementById('product-loading');
      const container = document.getElementById('product-detail');
      const error = document.getElementById('product-error');
      const id = getProductIdFromURL();
      if (!id) { loading.style.display = 'none'; error.style.display = 'block'; return; }

      // ensure initializeCart is run (it's safe to call if already run)
      if (typeof initializeCart === 'function') try { initializeCart(); } catch(e){ console.warn('init cart failed',e); }

      // wire nav cart icons (prevent anchor default that adds "/#")
      ['cart-toggle-desktop','cart-toggle-mobile'].forEach(i=>{
        const el=document.getElementById(i);
        if (el) el.addEventListener('click', (e)=>{ e.preventDefault(); if (typeof toggleCart==='function') toggleCart(); else if (typeof openCart==='function') openCart(); else {
          const panel=document.getElementById('cart-panel'), backdrop=document.getElementById('cart-backdrop');
          if (panel && backdrop) { panel.classList.toggle('open'); panel.setAttribute('aria-hidden', panel.classList.contains('open') ? 'false' : 'true'); backdrop.hidden = !backdrop.hidden; if (typeof renderCart==='function') renderCart(); }
        }});
      });

      // wait short while for window.supabase to be available
      if (!window.supabase) {
        // still try to wait a bit
        await new Promise(r => setTimeout(r, 200));
      }

      try {
        // fetch product (use maybeSingle to avoid throwing if not found)
        const { data: product, error } = await window.supabase
          .from('products')
          .select('*')
          .eq('id', id)
          .maybeSingle();

        loading.style.display = 'none';
        if (error) { console.error('Fetch product error', error); error.style.display='block'; error.querySelector('p').textContent='Error: '+(error.message||error); return; }
        if (!product) { error.style.display='block'; return; }

        // render page layout
        container.style.display = 'block';
        const inStock = !!(product.stock && product.stock > 0);

        container.innerHTML = `
          <div class="product-detail">
            <div class="product-info">
              <h1>${escapeHtml(product.name)}</h1>
              <div class="product-price-large">RWF ${product.price || 0}</div>
              <div class="product-stock ${inStock ? 'in' : 'out'}">${inStock ? '<i class="fas fa-check-circle"></i> '+product.stock+' in stock' : '<i class="fas fa-times-circle"></i> Out of stock'}</div>
              <div class="product-description">${escapeHtml(product.description || 'No description')}</div>

              <div class="quantity-selector">
                <div style="font-weight:700;">Quantity</div>
                <div class="quantity-controls" style="margin-left:8px;">
                  <button id="qty-decrease" ${!inStock?'disabled':''}>−</button>
                  <input id="quantity-input" type="number" value="1" min="1" max="${product.stock || 1}" readonly />
                  <button id="qty-increase" ${!inStock?'disabled':''}>+</button>
                </div>
              </div>

              <div class="action-buttons">
                <button id="btn-add-cart" class="btn-add-cart" ${!inStock?'disabled':''}><i class="fa-solid fa-cart-shopping"></i> Add to Cart</button>
                <button id="btn-buy-now" class="btn-buy-now" ${!inStock?'disabled':''}><i class="fa-solid fa-bolt"></i> Buy Now</button>
              </div>

              <a href="shop.html" class="back-link">← Back to Shop</a>
            </div>

            <div class="product-image-wrap">
              <img class="product-image-large" src="${escapeHtml(product.image_url || 'https://via.placeholder.com/800x800/fff0f3/ff9db1?text=No+Image')}" alt="${escapeHtml(product.name)}" />
            </div>
          </div>
        `;

        // small interactions
        const qtyInput = document.getElementById('quantity-input');
        document.getElementById('qty-increase').addEventListener('click', ()=> {
          const max = Number(qtyInput.max || 1);
          let cur = Number(qtyInput.value||1);
          if (cur < max) qtyInput.value = cur+1;
        });
        document.getElementById('qty-decrease').addEventListener('click', ()=> {
          let cur = Number(qtyInput.value||1);
          if (cur > 1) qtyInput.value = cur-1;
        });

        // ensure cart functions are available (wait a little)
        const { ready } = await waitForCartFns(40, 100);

        // add to cart behavior
        document.getElementById('btn-add-cart').addEventListener('click', async () => {
          const qty = Number(qtyInput.value || 1);
          try {
            if (typeof window.addToCartFromSupabase === 'function') {
              // call addToCartFromSupabase qty times for now (script.js add increases by 1)
              for (let i=0;i<qty;i++) await window.addToCartFromSupabase(product.id);
              if (typeof updateCartBadge === 'function') updateCartBadge();
              if (typeof showMessage === 'function') showMessage('Added to cart', 'success');
            } else if (typeof window.addToTempCart === 'function') {
              window.addToTempCart(product.id, qty);
              if (typeof updateCartBadge === 'function') updateCartBadge();
              if (typeof showMessage === 'function') showMessage('Added to local cart', 'success');
            } else {
              alert('Cart not available right now');
            }
          } catch (err) {
            console.error('Add to cart failed', err);
            alert('Failed to add to cart');
          }
        });

        // buy now: add to cart then either go to checkout (if signed-in) or open sign-in modal and set pending flag
        document.getElementById('btn-buy-now').addEventListener('click', async () => {
          const qty = Number(qtyInput.value || 1);
          try {
            // add to cart (server or temp)
            if (typeof window.addToCartFromSupabase === 'function') {
              await window.addToCartFromSupabase(product.id, qty);
            } else if (typeof window.addToTempCart === 'function') {
              window.addToTempCart(product.id, qty);
            } else {
              alert('Cart not available right now');
              return;
            }
        
            if (typeof updateCartBadge === 'function') updateCartBadge();
        
            // check auth; if user signed in -> go to checkout; otherwise show modal and set pending flag
            let signedIn = false;
            try {
              if (window.supabase && typeof window.supabase.auth?.getUser === 'function') {
                const { data } = await window.supabase.auth.getUser();
                if (data?.user) signedIn = true;
              } else if (window.currentUser && window.currentUser.id) {
                signedIn = true;
              }
            } catch (err) { console.warn('auth check failed', err); }
        
            if (signedIn) {
              window.location.href = 'checkout.html';
            } else {
              window.__pendingCheckout = true;
              const modal = document.getElementById('modal');
              if (modal) { modal.style.display = 'flex'; modal.classList.add('open'); }
              if (typeof showMessage === 'function') showMessage('Please sign in to proceed to checkout', 'info', 2500);
            }
          } catch (err) {
            console.error('Buy now failed', err);
            alert('Failed to process Buy Now.');
          }
        });


        // Protect checkout button inside cart to go to checkout.html (override existing handler)
        const checkoutBtn = document.getElementById('checkout');
        if (checkoutBtn) {
          checkoutBtn.removeEventListener && checkoutBtn.removeEventListener('click', null); // safe attempt
          checkoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            // go to checkout page
            window.location.href = 'checkout.html';
          });
        }

        // Ensure clear-cart button works even if script.js didn't hook a handler
        const clearBtn = document.getElementById('clear-cart');
        if (clearBtn) {
          clearBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (!confirm('Clear all items from cart?')) return;
            if (typeof handleClearCart === 'function') {
              try { await handleClearCart(); } catch(err){ console.warn('handleClearCart error',err); }
            } else {
              // fallback local
              if (typeof clearTempCart === 'function') clearTempCart();
              if (typeof updateCartBadge === 'function') updateCartBadge();
              if (typeof renderCart === 'function') renderCart();
              showMessage && showMessage('Cart cleared', 'success');
            }
          });
        }

        // ensure close X works
        const cartClose = document.getElementById('cart-close');
        if (cartClose) cartClose.addEventListener('click', (e)=>{ e.preventDefault(); if (typeof closeCart==='function') closeCart(); else { const p=document.getElementById('cart-panel'), b=document.getElementById('cart-backdrop'); if (p && b){ p.classList.remove('open'); p.setAttribute('aria-hidden','true'); b.hidden=true; } }});

      } catch (err) {
        console.error('Product page critical error:', err);
        loading.style.display = 'none';
        error.style.display = 'block';
        error.querySelector('p').textContent = 'Error: ' + (err.message || err);
      }
    }

    // init when DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadProductDetail);
    } else {
      loadProductDetail();
    }
  </script>
</body>
</html>




