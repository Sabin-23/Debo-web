<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details - ECHAD</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* your existing sproduct styles kept, unchanged */
    .product-detail-container { max-width:1200px;margin:50px auto;padding:20px; }
    .product-detail { display:grid; grid-template-columns:1fr 1fr; gap:40px; background:#fff; padding:30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.06); }
    .product-image-large { width:100%; max-height:500px; object-fit:cover; border-radius:12px; }
    .product-price-large { font-size:36px; color:#ff9db1; font-weight:700; margin:20px 0; }
    .product-stock { padding:8px 16px; border-radius:6px; display:inline-block; margin:10px 0; font-weight:600; }
    .quantity-controls button { width:40px; height:40px; border:none; background:#f5f5f5; cursor:pointer; font-size:20px; color:#333;}
    .btn-add-cart { background-color:#ff9db1;color:#fff;padding:15px 30px;border-radius:8px;border:none;font-weight:600;cursor:pointer;}
    .btn-buy-now { background:#333;color:#fff;padding:15px 30px;border-radius:8px;border:none;font-weight:600;cursor:pointer;}
  </style>
</head>
<body>

  <section id="header">
    <h4>ECHAD</h4>
    <div>
      <ul id="navbar">
        <li><a href="index.html">Home</a></li>
        <li><a class="active" href="shop.html">Shop</a></li>
        <li><a href="About.html">About</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li>
          <a href="#" id="cart-toggle-desktop" class="cart-btn" aria-label="Open cart">
            <i class="fa-solid fa-bag-shopping"></i>
            <span id="cart-badge" class="badge">0</span>
          </a>
        </li>
        <button id="openModal">Sign-in/Register</button>
      </ul>
      <div id="mobile">
        <a href="#" id="cart-toggle-mobile" class="cart-btn" aria-label="Open cart">
          <i class="fa-solid fa-bag-shopping"></i>
          <span id="cart-badge" class="badge">0</span>
        </a>
      </div>
    </div>
  </section>

  <div class="product-detail-container">
    <div id="product-loading" style="text-align:center;padding:60px;">
      <i class="fas fa-spinner fa-spin" style="font-size:48px;color:#ff9db1;"></i>
      <p style="margin-top:20px;font-size:18px;color:#666;">Loading product...</p>
    </div>

    <div id="product-detail" style="display:none;"></div>

    <div id="product-error" style="display:none;text-align:center;padding:60px;">
      <i class="fas fa-exclamation-circle" style="font-size:48px;color:#ff9db1;"></i>
      <p style="margin-top:20px;font-size:18px;color:#666;">Product not found</p>
      <a href="shop.html" class="back-link">← Back to Shop</a>
    </div>
  </div>

  <footer class="footer"> ... your footer ... </footer>

  <aside id="cart-panel" class="cart-panel" aria-hidden="true">
    <div class="cart-header">
      <h3>Your Cart</h3>
      <button id="cart-close" aria-label="Close cart">✕</button>
    </div>
    <div id="cart-items" class="cart-items"></div>
    <div class="cart-footer">
      <div class="cart-totals">
        <div>Subtotal</div>
        <div id="cart-subtotal">—</div>
      </div>
      <div class="cart-actions">
        <button id="checkout" class="accent">Checkout</button>
        <button id="clear-cart" class="secondary">Clear Cart</button>
      </div>
    </div>
  </aside>
  <div id="cart-backdrop" class="cart-backdrop" hidden></div>

  <script src="script.js"></script>

  <script>
    console.log('[SPRODUCT] PAGE LOADED');

    // utilities
    function escapeHtml(text){ const d = document.createElement('div'); d.textContent = text == null ? '' : String(text); return d.innerHTML; }
    function formatDate(iso){ if (!iso) return ''; const d=new Date(iso); return isNaN(d.getTime())?iso:d.toLocaleString(); }

    // 1) parse id from URL
    function getProductIdFromURL() {
      return new URLSearchParams(window.location.search).get('id');
    }

    // 2) robust waiter: wait until either addToCartFromSupabase OR addToTempCart is available,
    // with a max attempt guard so we don't loop forever.
    function waitForCartFns(maxAttempts = 40, interval = 100) {
      return new Promise((resolve) => {
        let attempts = 0;
        const id = setInterval(() => {
          attempts++;
          if (typeof window.addToCartFromSupabase === 'function' || typeof window.addToTempCart === 'function') {
            clearInterval(id);
            resolve(true);
          } else if (attempts >= maxAttempts) {
            clearInterval(id);
            resolve(false);
          }
        }, interval);
      });
    }

    // 3) load product
    async function loadProductDetail() {
      const loading = document.getElementById('product-loading');
      const container = document.getElementById('product-detail');
      const error = document.getElementById('product-error');
      const productId = getProductIdFromURL();

      if (!productId) { loading.style.display = 'none'; error.style.display = 'block'; return; }

      // wait briefly for script.js to initialize cart/supabase functions
      const cartFnsReady = await waitForCartFns(50, 100);
      console.log('[SPRODUCT] cart functions ready?', cartFnsReady);

      try {
        const { data: product, error: fetchError } = await window.supabase
          .from('products')
          .select('*')
          .eq('id', productId)
          .maybeSingle();

        loading.style.display = 'none';
        if (fetchError) { console.error(fetchError); error.style.display='block'; error.querySelector('p').textContent = 'Error: ' + fetchError.message; return; }
        if (!product) { error.style.display = 'block'; return; }

        // render
        container.style.display = 'block';
        const stockOk = !!(product.stock && product.stock > 0);

        container.innerHTML = `
          <div class="product-detail">
            <div>
              <img src="${escapeHtml(product.image_url || 'https://via.placeholder.com/500/fff0f3/ff9db1?text=No+Image')}"
                   alt="${escapeHtml(product.name)}" class="product-image-large" />
            </div>
            <div class="product-info">
              <h1>${escapeHtml(product.name)}</h1>
              <div class="product-price-large">RWF ${product.price || 0}</div>
              <div class="${stockOk ? 'product-stock' : 'product-stock out-of-stock'}">
                ${stockOk ? `<i class="fas fa-check-circle"></i> ${product.stock} in stock` : `<i class="fas fa-times-circle"></i> Out of stock`}
              </div>
              <div class="product-description">${escapeHtml(product.description || 'No description available')}</div>

              <div class="quantity-selector">
                <label>Quantity:</label>
                <div class="quantity-controls">
                  <button id="qty-decrease" ${!stockOk ? 'disabled' : ''}>−</button>
                  <input type="number" id="quantity-input" value="1" min="1" max="${product.stock || 1}" readonly>
                  <button id="qty-increase" ${!stockOk ? 'disabled' : ''}>+</button>
                </div>
              </div>

              <div class="action-buttons">
                <button id="btn-add-cart" class="btn-add-cart" ${!stockOk ? 'disabled' : ''}><i class="fa-solid fa-cart-shopping"></i> Add to Cart</button>
                <button id="btn-buy-now" class="btn-buy-now" ${!stockOk ? 'disabled' : ''}><i class="fa-solid fa-bolt"></i> Buy Now</button>
              </div>

              <a href="shop.html" class="back-link">← Back to Shop</a>
            </div>
          </div>
        `;

        // event wiring
        let quantity = 1;
        const qtyInput = document.getElementById('quantity-input');
        document.getElementById('qty-increase').addEventListener('click', () => {
          const max = Number(qtyInput.max || 1);
          let cur = Number(qtyInput.value || 1);
          if (cur < max) { cur++; qtyInput.value = cur; quantity = cur; }
        });
        document.getElementById('qty-decrease').addEventListener('click', () => {
          let cur = Number(qtyInput.value || 1);
          if (cur > 1) { cur--; qtyInput.value = cur; quantity = cur; }
        });

        const btnAdd = document.getElementById('btn-add-cart');
        btnAdd.addEventListener('click', async () => {
          // try server-backed add first, fallback to temp cart
          try {
            if (typeof window.addToCartFromSupabase === 'function') {
              // call once per item or call server to set quantity - here we'll call addToCartFromSupabase quantity times
              for (let i=0;i<quantity;i++) await window.addToCartFromSupabase(product.id);
              if (typeof updateCartBadge === 'function') updateCartBadge();
              if (typeof showMessage === 'function') showMessage('Added to cart', 'success');
            } else if (typeof window.addToTempCart === 'function') {
              window.addToTempCart(product.id, quantity);
              if (typeof updateCartBadge === 'function') updateCartBadge();
              if (typeof showMessage === 'function') showMessage('Added to local cart', 'success');
            } else {
              alert('Cart not available right now');
            }
          } catch (err) {
            console.error('Add to cart failed', err);
            alert('Failed to add to cart: ' + (err.message || err));
          }
        });

        document.getElementById('btn-buy-now').addEventListener('click', async () => {
          // ensure user signed in
          if (!window.currentUser) {
            if (confirm('Sign in to proceed to checkout?')) {
              const modal = document.getElementById('modal'); if (modal) { modal.style.display = 'flex'; modal.classList.add('open'); }
            }
            return;
          }
          // add to cart then open cart panel
          document.getElementById('btn-add-cart').click();
          setTimeout(() => {
            if (typeof toggleCart === 'function') toggleCart();
            else {
              const panel = document.getElementById('cart-panel'), backdrop = document.getElementById('cart-backdrop');
              if (panel && backdrop) { panel.classList.add('open'); panel.setAttribute('aria-hidden','false'); backdrop.hidden=false; if (typeof renderCart==='function') renderCart(); }
            }
          }, 400);
        });

      } catch (err) {
        console.error('sproduct critical error', err);
        loading.style.display = 'none';
        error.style.display = 'block';
        error.querySelector('p').textContent = 'Error: ' + (err.message || err);
      }
    }

    // initialize: wait for DOM and then load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => loadProductDetail());
    } else {
      loadProductDetail();
    }
  </script>
</body>
</html>
