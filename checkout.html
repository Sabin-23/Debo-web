<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout - ECHAD</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Page-specific CSS (additions) -->
  <style>
    :root {
      --accent: #ff9db1;
      --accent-strong: #ff69b4;
      --muted: #666;
      --panel-bg: #fff;
      --success: #2e7d32;
      --glass: rgba(255,240,243,0.6);
      --card-border: rgba(0,0,0,0.04);
    }

    /* Basic layout */
    .checkout-container {
      max-width: 1150px;
      margin: 28px auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: 220px 1fr 360px;
      gap: 18px;
      align-items: start;
    }

    /* cards */
    .panel-card {
      background: var(--panel-bg);
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 10px 28px rgba(24,12,20,0.04);
      border: 1px solid var(--card-border);
    }

    /* Left tabs (vertical) */
    .pay-tabs { display:flex; flex-direction:column; gap:10px; }
    .pay-tab {
      display:flex;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:10px;
      background: linear-gradient(180deg,#fff,#fff);
      border: 1px solid transparent;
      cursor:pointer;
      transition: all .16s ease;
      text-align:left;
      font-weight:700;
      color: #111;
    }
    .pay-tab i {
      width:42px;height:42px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;
      background:var(--glass); color:var(--accent-strong); font-size:18px;
    }
    .pay-tab .meta { font-size:13px; color:var(--muted); font-weight:600; display:block; opacity:.9; margin-top:4px; }

    .pay-tab.active {
      border-color: rgba(255,157,177,0.35);
      box-shadow: 0 8px 30px rgba(255,125,167,0.06);
      background: linear-gradient(180deg, #fffafc, #fff);
    }

    /* Payment area (middle) */
    .payment-area { min-height:320px; display:flex; flex-direction:column; gap:12px; }
    .pay-panel { display:none; }
    .pay-panel.active { display:block; }

    .ussd-box {
      display:flex; gap:12px; align-items:center; padding:12px; border-radius:10px;
      background: linear-gradient(180deg, rgba(255,248,250,1), #fff);
      border: 1px solid rgba(255,230,238,0.7);
    }
    .ussd-badge { background:#fff0f3;padding:8px 10px;border-radius:8px;font-weight:800;color: #3a2240; }

    .small-label { font-size:13px;color:var(--muted);margin-bottom:6px;display:block; }
    .input, input[type="tel"], input[type="text"] {
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid #eee; font-size:14px;
    }

    .btn-row { display:flex; gap:10px; margin-top:12px; align-items:center; }
    .btn-primary {
      padding:11px 14px; border-radius:10px; background:var(--success); color:white; border: none; cursor:pointer; font-weight:800;
    }
    .btn-secondary {
      padding:10px 12px; border-radius:10px; background:#fff; border:1px solid #eee; cursor:pointer;
    }

    /* Right order summary */
    .order-items { display:flex; flex-direction:column; gap:12px; margin-top:8px; }
    .order-line {
      display:flex; gap:12px; align-items:center; padding:12px; border-radius:8px; background:#fff; border:1px solid #fafafa;
    }
    .order-line img { width:72px; height:72px; object-fit:cover; border-radius:8px; }
    .order-meta h4 { margin:0; font-size:15px; }
    .order-meta p { margin:6px 0 0 0; color:var(--muted); font-size:13px; }

    .summary-row { display:flex; justify-content:space-between; margin-top:12px; font-weight:800; font-size:16px; }

    /* responsive */
    @media (max-width: 980px) {
      .checkout-container { grid-template-columns: 1fr; }
      .pay-tabs { flex-direction:row; gap:8px; overflow:auto; }
      .pay-tab { min-width:220px; flex:0 0 auto; }
    }

    /* small niceties */
    .muted { color:var(--muted); font-size:13px; }
  </style>
</head>
<body>
  <!-- header (keeps your nav/sign-in modal like other pages) -->
  <section id="header">
    <h4>ECHAD</h4>
    <div>
      <ul id="navbar">
        <li><a href="index.html">Home</a></li>
        <li><a href="shop.html">Shop</a></li>
        <li><a href="About.html">About</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li>
          <a href="#" id="cart-toggle-desktop" class="cart-btn" aria-label="Open cart">
            <i class="fa-solid fa-bag-shopping"></i>
            <span id="cart-badge" class="badge">0</span>
          </a>
        </li>
        <button id="openModal">Sign-in/Register</button>

        <div class="modal" id="modal">
          <div class="auth-container">
            <h2 id="form-title">Sign In</h2>
            <form id="signin-form" class="active">
              <input type="email" placeholder="Email" required />
              <input type="password" placeholder="Password" required />
              <button type="submit">Sign In</button>
              <a href="#" id="forgotPasswordLink" class="muted">Forgot password?</a>
            </form>
            <form id="register-form">
              <input type="text" placeholder="Full Name" required />
              <input type="email" placeholder="Email" required />
              <input type="password" placeholder="Password" required />
              <input type="password" placeholder="Confirm Password" required />
              <button type="submit">Register</button>
            </form>
            <p class="toggle-text muted">Don't have an account? <span id="toggle" style="color:var(--accent);cursor:pointer;">Register</span></p>
            <button id="closeModal" class="btn-secondary">Close</button>
          </div>
        </div>

      </ul>
    </div>
  </section>

  <!-- MAIN CHECKOUT -->
  <div class="checkout-container">
    <!-- left: vertical tabs -->
    <aside class="panel-card">
      <h3 style="margin-bottom:10px;">How would you like to pay?</h3>
      <div class="pay-tabs" id="payTabs">
        <button class="pay-tab" data-tab="mtn"><i class="fa-solid fa-mobile-screen-button"></i>
          <div>
            MTN Mobile Money
            <div class="meta">Fast, use USSD or enter phone</div>
          </div>
        </button>

        <button class="pay-tab" data-tab="airtel"><i class="fa-solid fa-signal"></i>
          <div>
            Airtel Money
            <div class="meta">Airtel momo</div>
          </div>
        </button>

        <button class="pay-tab" data-tab="card"><i class="fa-solid fa-credit-card"></i>
          <div>
            Debit / Credit Card
            <div class="meta">Card payment (UI only)</div>
          </div>
        </button>

        <button class="pay-tab" data-tab="cash"><i class="fa-solid fa-money-bill-wave"></i>
          <div>
            Cash / Agents
            <div class="meta">Pay on delivery / at agent</div>
          </div>
        </button>

        <button class="pay-tab" data-tab="banks"><i class="fa-solid fa-university"></i>
          <div>
            Bank Accounts
            <div class="meta">Transfer to bank</div>
          </div>
        </button>
      </div>
    </aside>

    <!-- middle: payment form area (panels) -->
    <section class="panel-card payment-area" id="paymentArea">
      <!-- MTN -->
      <div id="panel-mtn" class="pay-panel">
        <h4>MTN Mobile Money</h4>
        <p class="muted">Dial the USSD code shown or enter your MTN momo phone number to pay.</p>

        <div class="ussd-box" style="margin-top:8px;">
          <div class="ussd-badge">MTN</div>
          <div>
            <div style="font-weight:800;">*182*3*7*20311006246#</div>
            <div class="muted" style="margin-top:6px;">You will be prompted to confirm PIN on your phone</div>
          </div>
        </div>

        <label class="small-label" style="margin-top:12px;">MTN number (optional)</label>
        <input id="mtnPhone" class="input" type="tel" placeholder="e.g. 0789xxxxxx">

        <div class="btn-row">
          <button id="payMtnBtn" class="btn-primary">Pay <span id="mtnAmount">RWF 0</span></button>
          <button class="btn-secondary" id="mtnHelp">How to pay</button>
        </div>
      </div>

      <!-- Airtel -->
      <div id="panel-airtel" class="pay-panel">
        <h4>Airtel Money</h4>
        <p class="muted">Dial the USSD or enter Airtel phone number.</p>

        <div class="ussd-box" style="margin-top:8px;">
          <div class="ussd-badge">AIRTEL</div>
          <div>
            <div style="font-weight:800;">*185*1*20311006246#</div>
            <div class="muted" style="margin-top:6px;">You will be prompted to confirm PIN on your phone</div>
          </div>
        </div>

        <label class="small-label" style="margin-top:12px;">Airtel number (optional)</label>
        <input id="airtelPhone" class="input" type="tel" placeholder="e.g. 0789xxxxxx">

        <div class="btn-row">
          <button id="payAirtelBtn" class="btn-primary">Pay <span id="airtelAmount">RWF 0</span></button>
          <button class="btn-secondary">Help</button>
        </div>
      </div>

      <!-- Card -->
      <div id="panel-card" class="pay-panel">
        <h4>Debit / Credit Card</h4>
        <p class="muted">Card form is UI-only for now. Press Pay to create order records.</p>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
          <input id="cardName" class="input" placeholder="Name on card" />
          <input id="cardNumber" class="input" placeholder="4242 4242 4242 4242" />
          <input id="cardExp" class="input" placeholder="MM / YY" />
          <input id="cardCVC" class="input" placeholder="CVC" />
        </div>

        <div class="btn-row">
          <button id="payCardBtn" class="btn-primary">Pay <span id="cardAmount">RWF 0</span></button>
          <button class="btn-secondary">Save card</button>
        </div>
      </div>

      <!-- Cash -->
      <div id="panel-cash" class="pay-panel">
        <h4>Cash / Agents</h4>
        <p class="muted">Pay the courier or an agent on delivery.</p>

        <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px;">
          <label><input type="radio" name="cashOpt" value="agent" checked> Pay via local agent</label>
          <label><input type="radio" name="cashOpt" value="courier"> Pay courier on delivery</label>
        </div>

        <div class="btn-row">
          <button id="checkoutCashBtn" class="btn-primary">Checkout (Cash) — <span id="cashAmount">RWF 0</span></button>
          <button class="btn-secondary">Contact us</button>
        </div>
      </div>

      <!-- Banks -->
      <div id="panel-banks" class="pay-panel">
        <h4>Bank Accounts</h4>
        <p class="muted">Transfer to any of the accounts below and notify us.</p>

        <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px;">
          <div style="padding:10px;border-radius:8px;border:1px solid #f4f4f4;">
            <div style="font-weight:800;">Bank of Kigali</div>
            <div class="muted">Account: 20311006246 · ECHAD Ltd</div>
          </div>
          <div style="padding:10px;border-radius:8px;border:1px solid #f4f4f4;">
            <div style="font-weight:800;">Equity Bank</div>
            <div class="muted">Account: 20311006247 · ECHAD Ltd</div>
          </div>
          <div style="padding:10px;border-radius:8px;border:1px solid #f4f4f4;">
            <div style="font-weight:800;">I&M Bank</div>
            <div class="muted">Account: 20311006248 · ECHAD Ltd</div>
          </div>
        </div>

        <div class="btn-row">
          <button id="bankNoticeBtn" class="btn-primary">I've paid — Notify</button>
          <button class="btn-secondary">Copy accounts</button>
        </div>
      </div>
    </section>

    <!-- right: order summary (keeps your original site look) -->
    <aside class="panel-card">
      <h3>Your Order</h3>
      <div id="orderItems" class="order-items">
        <div class="muted">Loading cart…</div>
      </div>

      <div class="summary-row" style="margin-top:14px;">
        <div>Subtotal</div>
        <div id="subtotal">RWF 0</div>
      </div>
      <div class="summary-row" style="margin-top:8px;">
        <div>Shipping</div>
        <div id="shipping">RWF 0</div>
      </div>
      <div class="summary-row" style="margin-top:12px;font-size:18px;">
        <div>Total</div>
        <div id="total">RWF 0</div>
      </div>
    </aside>
  </div>

  <!-- cart side panel (kept for compatibility) -->
  <aside id="cart-panel" class="cart-panel" aria-hidden="true">
    <div class="cart-header">
      <h3>Your Cart</h3>
      <button id="cart-close" aria-label="Close cart">✕</button>
    </div>
    <div id="cart-items" class="cart-items"></div>
    <div class="cart-footer">
      <div class="cart-totals"><div>Subtotal</div><div id="cart-subtotal">—</div></div>
      <div class="cart-actions">
        <button id="checkout" class="accent">Checkout</button>
        <button id="clear-cart" class="secondary">Clear Cart</button>
      </div>
    </div>
  </aside>
  <div id="cart-backdrop" class="cart-backdrop" hidden></div>

  <script src="script.js"></script>

  <!-- Minimal JS to wire tabs -> reuses your checkout logic and functions already added earlier -->
  <script>
    (function(){
      // Tab switching (mirrors admin.html behaviour)
      const tabs = document.querySelectorAll('.pay-tab');
      const panels = document.querySelectorAll('.pay-panel');

      function showTab(name) {
        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
        panels.forEach(p => p.classList.toggle('active', p.id === 'panel-' + name));
      }

      tabs.forEach(t => {
        t.addEventListener('click', () => showTab(t.dataset.tab));
      });

      // default tab
      showTab('mtn');

      // tiny helper to format amounts and update all pay buttons
      function updateAmounts(total) {
        document.getElementById('mtnAmount').textContent = `RWF ${total}`;
        document.getElementById('airtelAmount').textContent = `RWF ${total}`;
        document.getElementById('cardAmount').textContent = `RWF ${total}`;
        document.getElementById('cashAmount').textContent = `RWF ${total}`;
        document.getElementById('subtotal').textContent = `RWF ${total}`;
        document.getElementById('total').textContent = `RWF ${total}`;
      }

      // attempt to reuse page logic: load cart and update UI (same as previous checkout logic)
      async function loadCartSummary() {
        if (!window.supabase) {
          // wait a bit — script.js should create supabase
          setTimeout(loadCartSummary, 200);
          return;
        }

        let sessionUser = window.currentUser || null;
        if (!sessionUser) {
          try {
            const { data } = await window.supabase.auth.getSession();
            sessionUser = data?.session?.user || null;
          } catch(e){ sessionUser = null; }
        }

        if (!sessionUser) {
          document.getElementById('orderItems').innerHTML = '<div class="muted">Sign in to view cart</div>';
          updateAmounts(0);
          return;
        }

        try {
          const { data: cart } = await window.supabase.from('cart_items').select('*').eq('user_id', sessionUser.id);
          if (!cart || cart.length === 0) {
            document.getElementById('orderItems').innerHTML = '<div class="muted">Your cart is empty.</div>';
            updateAmounts(0);
            return;
          }

          const ids = cart.map(ci => ci.product_id);
          const { data: products } = await window.supabase.from('products').select('*').in('id', ids);
          const pmap = {};
          (products||[]).forEach(p=>pmap[p.id]=p);

          let subtotal = 0;
          const html = cart.map(ci => {
            const p = pmap[ci.product_id] || {};
            const qty = Number(ci.quantity || 1);
            const price = Number(p.price || 0);
            subtotal += price * qty;
            return `
              <div class="order-line">
                <img src="${p.image_url || 'https://via.placeholder.com/80'}" alt="${(p.name||'Product')}">
                <div class="order-meta">
                  <h4>${(p.name||'Product')}</h4>
                  <p>Qty: ${qty} • RWF ${price}</p>
                </div>
                <div style="font-weight:800;">RWF ${price * qty}</div>
              </div>`;
          }).join('');
          document.getElementById('orderItems').innerHTML = html;
          updateAmounts(subtotal);
        } catch (err) {
          console.error('checkout summary error', err);
          document.getElementById('orderItems').innerHTML = '<div class="muted">Error loading cart</div>';
          updateAmounts(0);
        }
      }

      // Try to init once script.js loaded supabase
      window.addEventListener('load', () => {
        setTimeout(loadCartSummary, 250);
      });

      // expose for other scripts to refresh if needed
      window.refreshCheckoutSummary = loadCartSummary;
    })();
  </script>
</body>
</html>
