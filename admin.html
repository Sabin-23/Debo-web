<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard (Debuggable Upload)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    /* Kept UI styling as you had it (pink theme) */
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial}
    body{display:flex;min-height:100vh;background:linear-gradient(180deg,#ffeef6,#fff0f8);color:#2a0a20}
    .sidebar{width:260px;background:#ff6fb5;color:#fff;padding:18px;display:flex;flex-direction:column;gap:10px}
    .brand{font-size:18px;font-weight:700;margin-bottom:6px}
    .muted{opacity:.9;font-size:13px}
    .nav{margin-top:18px;display:flex;flex-direction:column;gap:6px}
    .nav button{background:transparent;border:none;color:inherit;text-align:left;padding:10px;border-radius:8px;cursor:pointer;font-weight:600}
    .nav button.active{background:rgba(255,255,255,0.12)}
    .nav .logout{margin-top:auto;background:transparent;border-top:1px solid rgba(255,255,255,0.12);padding-top:12px}
    .main{flex:1;padding:22px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(200,40,90,0.06)}
    .orders-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
    .order-card{display:flex;gap:12px;align-items:center;padding:12px;border-radius:8px;border:1px solid #ffe6f0;background:linear-gradient(180deg,#fff,#fff6fb)}
    .order-card img{width:86px;height:86px;object-fit:cover;border-radius:8px}
    .order-info{flex:1}
    .order-meta{display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap}
    .pill{padding:6px 8px;border-radius:999px;background:#fff9fb;font-size:13px;border:1px solid #ffe6f0}
    .status-dot{width:12px;height:12px;border-radius:50%;box-shadow:0 0 0 3px rgba(0,0,0,0.02)}
    label{display:block;font-size:13px;margin-bottom:6px}
    input[type=text],input[type=number],textarea{width:100%;padding:8px;border:1px solid #f5d9e8;border-radius:6px;background:#fff}
    button.primary{background:#ff3b99;color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#ffd6ec;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    button.danger{background:#ffb3d6;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;text-align:left;border-bottom:1px solid #fff1f6}
    th{background:#fff}
    .messages-wrap{display:flex;gap:12px}
    .msg-list{width:360px;background:#fff;border-radius:10px;padding:10px;height:600px;overflow:auto}
    .msg-item{display:flex;gap:10px;padding:10px;border-radius:8px;align-items:center;cursor:pointer}
    .msg-item:hover{background:#fff6fb}
    .msg-content{flex:1}
    .product-card{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:10px;background:#fff;border:1px solid #ffe6f0;width:220px}
    .products-grid{display:flex;flex-wrap:wrap;gap:12px}
    .log{font-family:monospace;background:#fff6fb;padding:8px;border-radius:6px;border:1px solid #ffe6f0;font-size:13px;max-height:140px;overflow:auto}
    @media (max-width:900px){.sidebar{display:none}.main{padding:12px}}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">Admin</div>
    <div class="muted">Administrator panel</div>
    <nav class="nav" aria-label="Admin navigation">
      <button data-tab="orders" class="active">Orders</button>
      <button data-tab="upload">Upload (new product)</button>
      <button data-tab="analysis">Analysis</button>
      <button data-tab="users">Users</button>
      <button data-tab="products">All products</button>
      <button data-tab="messages">Messages</button>
      <button id="logoutBtn" class="logout">Logout</button>
    </nav>
  </aside>

  <main class="main">
    <div class="topbar">
      <h2>Admin Dashboard</h2>
      <div class="muted">Connected to your Supabase project</div>
    </div>

    <!-- UPLOAD -->
    <section id="tab-upload" class="card tab-panel" style="display:block;margin-top:16px">
      <h3>Upload New Product</h3>
      <form id="productForm" style="margin-top:12px">
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="width:200px">
            <label>Image</label>
            <div class="preview-wrap">
              <img id="previewImg" src="" alt="preview" style="width:180px;height:180px;object-fit:cover;border-radius:8px;border:1px solid #ffe6f0"/>
              <input id="fileInput" type="file" accept="image/*" />
            </div>
            <div class="muted" style="font-size:12px">Images are uploaded to Supabase bucket <code>product-images</code>.</div>
          </div>
          <div style="flex:1;display:flex;flex-direction:column;gap:8px">
            <div>
              <label>Product Name</label>
              <input id="prodName" type="text" placeholder="e.g., Black Hoodie" required />
            </div>
            <div>
              <label>Price (RWF)</label>
              <input id="prodPrice" type="number" step="1" min="0" placeholder="e.g., 25000" required />
            </div>
            <div>
              <label>Quantity / Stock</label>
              <input id="prodQty" type="number" step="1" min="0" placeholder="e.g., 10" required />
            </div>
            <div>
              <label>Description</label>
              <textarea id="prodDesc" rows="4" placeholder="Short description"></textarea>
            </div>
            <div style="display:flex;gap:8px;margin-top:6px">
              <button class="primary" type="submit">Add Item</button>
              <button type="button" id="clearForm" class="danger">Clear All</button>
            </div>
            <div id="uploadStatus" class="muted" style="margin-top:6px">Ready</div>
            <div style="margin-top:8px">
              <div style="font-weight:600;margin-bottom:6px">Client-side debug log (also open dev console)</div>
              <div id="clientLog" class="log">Ready\n</div>
            </div>
            <div id="messageBox"></div>
          </div>
        </div>
      </form>
    </section>

    <!-- PRODUCTS -->
    <section id="tab-products" class="card tab-panel" style="display:none;margin-top:16px">
      <h3>All Products</h3>
      <div style="margin-top:10px;overflow:auto">
        <div id="productsGrid" class="products-grid"></div>
      </div>
    </section>

  </main>

  <script>
    // ---------- CONFIG ----------
    const SUPABASE_URL = 'https://hlskxkqwymuxcjgswqnv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhsc2t4a3F3eW11eGNqZ3N3cW52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzQ1ODIsImV4cCI6MjA3MzAxMDU4Mn0.NdGjbd7Y1QorTF5BIqAduItcvbh1OdP1Y2qNYf0pILw';
    const BUCKET = 'product-images';

    // small helper to append readable logs to on-page log box
    function clientLog(msg){
      try{
        const el = document.getElementById('clientLog');
        const now = (new Date()).toLocaleTimeString();
        el.textContent = el.textContent + `[${now}] ${msg}\n`;
        el.scrollTop = el.scrollHeight;
      }catch(e){ console.log('log error', e); }
      console.log(msg);
    }
  function showMessage(msg, type) {
    const msgBox = document.getElementById('msgBox');
    msgBox.textContent = msg;
    msgBox.style.color = (type === 'success') ? 'green' : 'red';
}


    // attach tab handlers immediately so UI works even if errors occur later
    (function attachTabsImmediately(){
      const tabButtons = document.querySelectorAll('.nav button[data-tab]');
      const panels = document.querySelectorAll('.tab-panel');
      function show(name){
        tabButtons.forEach(b=>b.classList.remove('active'));
        const btn = document.querySelector(`.nav button[data-tab="${name}"]`);
        if(btn) btn.classList.add('active');
        panels.forEach(p=>p.style.display='none');
        const panel = document.getElementById('tab-'+name);
        if(panel) panel.style.display='block';
      }
      document.querySelectorAll('.nav button[data-tab]').forEach(btn=>{
        btn.addEventListener('click', ()=> show(btn.getAttribute('data-tab')));
      });
      // default
      const initial = document.querySelector('.nav button[data-tab].active') ? document.querySelector('.nav button[data-tab].active').getAttribute('data-tab') : 'orders';
      show(initial);
    })();

    // init supabase
    let supabase = null;
    try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); clientLog('Supabase client initialized'); }
    catch(e){ console.error('Supabase init error', e); clientLog('Supabase init error: ' + e.message); }

    // helpers
    function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>\"']/g, s=> ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"}[s])); }
    function getPublicUrlForPath(path){
      try {
        const res = supabase.storage.from(BUCKET).getPublicUrl(path);
        clientLog('getPublicUrl returned: ' + JSON.stringify(res));
        if(res && res.data && res.data.publicUrl) return res.data.publicUrl;
        if(res && res.publicURL) return res.publicURL;
      } catch(e){ console.warn('getPublicUrl error', e); clientLog('getPublicUrl error: ' + e.message); }
      return null;
    }
    function extractPathFromPublicUrl(url){
      if(!url) return null;
      const marker = `/storage/v1/object/public/${BUCKET}/`;
      const i = url.indexOf(marker);
      if(i === -1) return null;
      return url.slice(i + marker.length);
    }

    // ---------- UPLOAD PRODUCT (debuggable flow) ----------
    const uploadFileInput = document.getElementById('fileInput');
    const uploadPreview = document.getElementById('previewImg');
    let uploadSelectedFile = null;
    uploadFileInput.addEventListener('change', e=>{
      const f = e.target.files[0]; uploadSelectedFile = f || null;
      if(!f){ uploadPreview.src=''; clientLog('No file selected'); return; }
      uploadPreview.src = URL.createObjectURL(f);
      clientLog('File selected: ' + f.name + ' (' + f.type + ', ' + f.size + ' bytes)');
    });

    document.getElementById('clearForm').addEventListener('click', ()=>{
      document.getElementById('prodName').value=''; document.getElementById('prodPrice').value=''; document.getElementById('prodQty').value=''; document.getElementById('prodDesc').value=''; uploadFileInput.value=''; uploadSelectedFile=null; uploadPreview.src=''; document.getElementById('uploadStatus').textContent='Cleared'; clientLog('Form cleared');
    });

    document.getElementById('productForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = document.getElementById('prodName').value.trim();
      const price = parseInt(document.getElementById('prodPrice').value||0,10);
      const qty = parseInt(document.getElementById('prodQty').value||0,10);
      const desc = document.getElementById('prodDesc').value.trim();
      const statusEl = document.getElementById('uploadStatus');

      if(!name){ alert('Name required'); return; }
      if(!uploadSelectedFile){ alert('Please select an image'); return; }
      statusEl.textContent = 'Starting upload...';

      try {
        if(!supabase) throw new Error('Supabase not initialized');

        clientLog('STEP 1 – Check current auth user');
        statusEl.textContent = 'Checking authentication...';
        const { data: userData, error: userErr } = await supabase.auth.getUser();
        if(userErr) { console.warn('getUser error', userErr); clientLog('getUser error: ' + JSON.stringify(userErr)); statusEl.textContent = 'Auth check failed'; return; }
        const user = userData && userData.user;
        clientLog('Auth user: ' + (user ? user.id : 'null'));
        if(!user){ alert('You must be signed in to add a product.'); statusEl.textContent = 'Sign-in required'; clientLog('No user signed in'); return; }

        // check duplicate name (optional)
        clientLog('STEP 2 – Checking duplicate product name');
        statusEl.textContent = 'Checking product name...';
        const { data: existing, error: existErr } = await supabase.from('products').select('id').eq('name', name).maybeSingle();
        if(existErr){ console.warn('check existing name error', existErr); clientLog('check existing name error: ' + JSON.stringify(existErr)); }
        if(existing && existing.id){ alert('A product with that name already exists. Choose a different name.'); statusEl.textContent = 'Duplicate name'; clientLog('Duplicate product name detected'); return; }

        clientLog('STEP 3 – Uploading image to storage');
        statusEl.textContent = 'Uploading image...';
        const file = uploadSelectedFile;
        const ext = (file.name||'').split('.').pop();
        const safeFileName = `prod_${Date.now()}.${ext||'png'}`;
        const storagePath = safeFileName;

        // upload to storage
        const { data: uploadData, error: uploadError } = await supabase.storage.from(BUCKET).upload(storagePath, file, {contentType: file.type, upsert:false});
        clientLog('Upload response: ' + JSON.stringify(uploadData) + ' / error: ' + JSON.stringify(uploadError));
        if(uploadError){
          console.error('storage upload error', uploadError);
          statusEl.textContent = 'Image upload failed: ' + (uploadError.message || JSON.stringify(uploadError));
          clientLog('Storage upload failed: ' + JSON.stringify(uploadError));
          return;
        }

        clientLog('STEP 4 – Getting public URL');
        statusEl.textContent = 'Getting public URL...';
        const pubRes = supabase.storage.from(BUCKET).getPublicUrl(storagePath);
        clientLog('getPublicUrl raw: ' + JSON.stringify(pubRes));
        let publicUrl = null;
        if(pubRes && pubRes.data && pubRes.data.publicUrl) publicUrl = pubRes.data.publicUrl;
        else if(pubRes && pubRes.publicURL) publicUrl = pubRes.publicURL;
        clientLog('Public URL: ' + publicUrl);

        // If your bucket is private, getPublicUrl might return null — handle that case in your app flows.
        if(!publicUrl){ clientLog('No public URL — bucket might be private. You can use signed URLs server-side.'); }

        clientLog('STEP 5 – Inserting product row into DB');
        statusEl.textContent = 'Inserting product row...';
        const insertPayload = { name, price, stock: qty, description: desc, image_url: publicUrl, owner: user.id };
        clientLog('Insert payload: ' + JSON.stringify(insertPayload));

        const { data: insertData, error: insertErr } = await supabase.from('products').insert([insertPayload]);
        clientLog('Insert response: data=' + JSON.stringify(insertData) + ' error=' + JSON.stringify(insertErr));
        if(insertErr){
          // DB refused the insert (likely RLS). Clean up the storage file so it doesn't remain orphan.
          statusEl.textContent = 'Insert failed: ' + (insertErr.message || JSON.stringify(insertErr));
          clientLog('Insert failed. Attempting to remove uploaded file to avoid orphaned storage file.');
          try { await supabase.storage.from(BUCKET).remove([storagePath]); clientLog('Removed uploaded file: ' + storagePath); } catch(removeErr){ console.warn('cleanup failed', removeErr); clientLog('Failed to remove uploaded file: ' + JSON.stringify(removeErr)); }
          return;
        }

        statusEl.textContent = 'Saved to products table.';
        clientLog('Product saved successfully: ' + JSON.stringify(insertData));
        document.getElementById('clearForm').click();
        // refresh products if visible
        if(document.getElementById('tab-products').style.display!=='none') loadProducts();

      } catch(err){
        console.error('product upload error', err);
        clientLog('Unexpected error: ' + (err.message || JSON.stringify(err)));
        document.getElementById('uploadStatus').textContent = 'Error: ' + (err.message || JSON.stringify(err));
      }
    });

    // ---------- PRODUCTS (list) ----------
    async function loadProducts(){
      const grid = document.getElementById('productsGrid'); grid.innerHTML = '';
      if(!supabase){ grid.innerHTML = '<div class="muted">Supabase not initialized</div>'; return; }
      try {
        const { data, error } = await supabase.from('products').select('*').order('created_at', {ascending:false});
        if(error) throw error;
        if(!data || data.length===0){ grid.innerHTML = '<div class="muted">No products yet.</div>'; return; }
        data.forEach(p=>{
          const card = document.createElement('div'); card.className='product-card';
          const img = document.createElement('img'); img.src = p.image_url || 'https://via.placeholder.com/180/ffe6f0/ff6fb5?text=No+Img'; img.style.width='180px'; img.style.height='180px'; img.style.objectFit='cover'; img.style.borderRadius='8px';
          const title = document.createElement('div'); title.innerHTML = `<strong>${escapeHtml(p.name||'')}</strong>`;
          const desc = document.createElement('div'); desc.style.fontSize='13px'; desc.style.color='#333'; desc.textContent = p.description||'';
          const price = document.createElement('div'); price.textContent = 'RWF ' + (p.price||0);
          const stock = document.createElement('div'); stock.textContent = 'Stock: ' + (p.stock||0);
          // Inside your loop where you build each product row/card
          const delBtn = document.createElement('button');
            delBtn.textContent = "Delete Product";
            delBtn.className = "delete-btn"; // style it in CSS (red button)
            
            // Attach delete handler
            delBtn.onclick = async () => {
              if (!confirm("Are you sure you want to delete this product?")) return;
            
              try {
                // 1. Remove image from storage (if present)
                if (p.image_url) {
                  const path = extractPathFromPublicUrl(p.image_url);
                  if (path) {
                    const { error: storageErr } = await supabase.storage.from("product-images").remove([path]);
                    if (storageErr) {
                      showMessage("Failed to delete product image. Aborting.", "error");
                      return;
                    }
                  }
                }
            
                // 2. Delete row from database
                const { error: dbErr } = await supabase.from("products").delete().eq("id", p.id);
                if (dbErr) {
                  showMessage("Failed to delete product from database.", "error");
                  return;
                }
            
                showMessage("Product deleted successfully!", "success");
          
              // Refresh product list
              loadProducts();
          
            } catch (err) {
              showMessage("Unexpected error while deleting product.", "error");
            }
          };
          
          // Add button to your product card
          productDiv.appendChild(delBtn);

          card.appendChild(img); card.appendChild(title); card.appendChild(desc); card.appendChild(price); card.appendChild(stock);
          grid.appendChild(card);
        });
      } catch(err){
        console.error('loadProducts error', err);
        document.getElementById('productsGrid').innerHTML = '<div class="muted">Error loading products: ' + (err.message || JSON.stringify(err)) + '</div>';
      }
      
    }

    // initial load
    setTimeout(()=>{ loadProducts(); }, 300);

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      try{ if(supabase) await supabase.auth.signOut(); }catch(e){ console.warn('signout', e); }
      location.reload();
    });
    function extractPathFromPublicUrl(url) {
      // Example: https://xyz.supabase.co/storage/v1/object/public/product-images/abc.png
      const parts = url.split("/product-images/");
      return parts[1] || null;
    }
    function showMessage(msg, type = "success") {
    const box = document.getElementById("messageBox");
    box.textContent = msg;
    box.style.color = (type === "success") ? "green" : "red";
    }


    // expose loaders for debugging
    window.loadProducts = loadProducts;

  </script>
</body>
</html>

