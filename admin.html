<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - ECHAD</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial}
    body{display:flex;min-height:100vh;background:linear-gradient(180deg,#ffeef6,#fff0f8);color:#2a0a20}
    .sidebar{width:260px;background:#ff6fb5;color:#fff;padding:18px;display:flex;flex-direction:column;gap:10px}
    .brand{font-size:18px;font-weight:700;margin-bottom:6px}
    .muted{opacity:.9;font-size:13px}
    .nav{margin-top:18px;display:flex;flex-direction:column;gap:6px}
    .nav button{background:transparent;border:none;color:inherit;text-align:left;padding:10px;border-radius:8px;cursor:pointer;font-weight:600}
    .nav button.active{background:rgba(255,255,255,0.12)}
    .nav .logout{margin-top:auto;background:transparent;border-top:1px solid rgba(255,255,255,0.12);padding-top:12px}
    .main{flex:1;padding:22px;overflow:auto}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(200,40,90,0.06);margin-bottom:16px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input[type=text],input[type=number],textarea,input[type=file]{width:100%;padding:8px;border:1px solid #f5d9e8;border-radius:6px;background:#fff}
    button.primary{background:#ff3b99;color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    button.danger{background:#ffb3d6;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:12px;text-align:left;border-bottom:1px solid #fff1f6}
    th{background:#fff6fb;font-weight:600;color:#333}
    td{background:#fff}
    .product-card{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:10px;background:#fff;border:1px solid #ffe6f0;width:220px}
    .products-grid{display:flex;flex-wrap:wrap;gap:12px}
    .log{font-family:monospace;background:#fff6fb;padding:8px;border-radius:6px;border:1px solid #ffe6f0;font-size:13px;max-height:140px;overflow:auto}
    .tab-panel{display:none}
    .tab-panel.active{display:block}
    @media (max-width:900px){.sidebar{display:none}.main{padding:12px}}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">Admin Dashboard</div>
    <div class="muted">God's Only Store</div>
    <nav class="nav">
      <button data-tab="orders" class="active">Orders</button>
      <button data-tab="upload">Upload Product</button>
      <button data-tab="products">All Products</button>
      <button data-tab="users">Users/Profiles</button>
      <button id="logoutBtn" class="logout">Logout</button>
    </nav>
  </aside>

  <main class="main">
    <div class="topbar">
      <h2>Admin Panel</h2>
      <div class="muted">Manage your store</div>
    </div>

    <!-- ORDERS TAB -->
    <section id="tab-orders" class="card tab-panel active">
      <h3>All Orders</h3>
      <div style="margin-top:10px;overflow:auto">
        <div id="ordersList" class="orders-list"></div>
      </div>
    </section>

        <!-- UPLOAD TAB -->
    <section id="tab-upload" class="card tab-panel">
      <h3>Upload New Product</h3>
      <form id="productForm" style="margin-top:12px">
        <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;">
          <div style="width:200px">
            <label>Product Image</label>
            <img id="previewImg" src="" alt="preview" style="width:180px;height:180px;object-fit:cover;border-radius:8px;border:1px solid #ffe6f0;display:block;margin-bottom:8px;"/>
            <input id="fileInput" type="file" accept="image/*" />
            <div class="muted" style="font-size:12px;margin-top:8px;">Uploaded to Supabase storage</div>
          </div>
          <div style="flex:1;min-width:300px;display:flex;flex-direction:column;gap:8px">
            <div>
              <label>Product Name</label>
              <input id="prodName" type="text" placeholder="e.g., Black Hoodie" required />
            </div>
            <div>
              <label>Price (RWF)</label>
              <input id="prodPrice" type="number" step="1" min="0" placeholder="e.g., 25000" required />
            </div>
            <div>
              <label>Stock Quantity</label>
              <input id="prodQty" type="number" step="1" min="0" placeholder="e.g., 10" required />
            </div>
            <div>
              <label>Description</label>
              <textarea id="prodDesc" rows="4" placeholder="Product description"></textarea>
            </div>
            <div style="display:flex;gap:8px;margin-top:6px">
              <button class="primary" type="submit">Add Product</button>
              <button type="button" id="clearForm" class="danger">Clear</button>
            </div>
            <div id="uploadStatus" class="muted" style="margin-top:6px">Ready</div>
            <div id="messageBox" style="margin-top:8px;padding:8px;border-radius:6px;display:none;"></div>
          </div>
        </div>
      </form>
    </section>



    <!-- USERS TAB -->
    <section id="tab-users" class="card tab-panel">
      <h3>User Profiles</h3>
      <div style="margin-top:10px;overflow-x:auto;">
        <div id="profilesLoading" style="text-align:center;padding:20px;color:#666;">Loading profiles...</div>
        <table id="profilesTable" style="display:none;">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Admin</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="profilesTableBody"></tbody>
        </table>
        <div id="profilesEmpty" style="display:none;text-align:center;padding:40px;color:#666;">No profiles found.</div>
      </div>
    </section>

    <!-- PRODUCTS TAB -->
    <section id="tab-products" class="card tab-panel">
      <h3>All Products</h3>
      <div style="margin-top:10px;overflow:auto">
        <div id="productsGrid" class="products-grid"></div>
      </div>
    </section>

  </main>

  <script>
    const SUPABASE_URL = 'https://hlskxkqwymuxcjgswqnv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhsc2t4a3F3eW11eGNqZ3N3cW52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzQ1ODIsImV4cCI6MjA3MzAxMDU4Mn0.NdGjbd7Y1QorTF5BIqAduItcvbh1OdP1Y2qNYf0pILw';
    const BUCKET = 'product-images';
    
    let supabase = null;
    
    function showMessage(msg, type) {
      const msgBox = document.getElementById('messageBox');
      msgBox.textContent = msg;
      msgBox.style.display = 'block';
      msgBox.style.color = (type === 'success') ? 'green' : 'red';
      msgBox.style.background = (type === 'success') ? '#e8f5e9' : '#ffecec';
      setTimeout(() => msgBox.style.display = 'none', 5000);
    }
    
    // Tab system
    (function() {
      const tabButtons = document.querySelectorAll('.nav button[data-tab]');
      const panels = document.querySelectorAll('.tab-panel');
      
      function showTab(name) {
        tabButtons.forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`.nav button[data-tab="${name}"]`);
        if (btn) btn.classList.add('active');
        panels.forEach(p => p.classList.remove('active'));
        const panel = document.getElementById('tab-' + name);
        if (panel) panel.classList.add('active');
        if (name === 'users') loadProfiles();
        if (name === 'products') loadProducts();
        if (name === 'orders') loadOrders();
      }
      
      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => showTab(btn.getAttribute('data-tab')));
      });
      
      showTab('orders');
    })();
    
    // Init
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (e) {
      console.error('Supabase init error:', e);
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]));
    }
    
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }
    
    function extractPathFromUrl(url) {
      if (!url) return null;
      const marker = `/storage/v1/object/public/${BUCKET}/`;
      const i = url.indexOf(marker);
      return i === -1 ? null : url.slice(i + marker.length);
    }
    
    // Load Profiles
    async function loadProfiles() {
      const loading = document.getElementById('profilesLoading');
      const table = document.getElementById('profilesTable');
      const tbody = document.getElementById('profilesTableBody');
      const empty = document.getElementById('profilesEmpty');
      
      loading.style.display = 'block';
      table.style.display = 'none';
      empty.style.display = 'none';
      
      if (!supabase) {
        loading.innerHTML = '<div style="color:#c62828;">Supabase not initialized</div>';
        return;
      }
      
      try {
        const { data: profiles, error } = await supabase
          .from('profiles')
          .select('*')
          .order('created_at', { ascending: false });
        
        loading.style.display = 'none';
        
        if (error) throw error;
        if (!profiles || profiles.length === 0) {
          empty.style.display = 'block';
          return;
        }
        
        tbody.innerHTML = '';
        
        profiles.forEach(profile => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHtml(profile.full_name || 'N/A')}</td>
            <td>${escapeHtml(profile.email || 'N/A')}</td>
            <td>${escapeHtml(profile.phone || 'N/A')}</td>
            <td>
              <span style="padding:4px 8px;border-radius:12px;font-size:12px;background:${profile.is_admin ? '#ff9db1' : '#e0e0e0'};color:${profile.is_admin ? '#fff' : '#666'};">
                ${profile.is_admin ? 'Yes' : 'No'}
              </span>
            </td>
            <td style="font-size:12px;color:#666;">${formatDate(profile.created_at)}</td>
          `;
          tbody.appendChild(row);
        });
        
        table.style.display = 'table';
      } catch (err) {
        console.error('Load profiles error:', err);
        loading.innerHTML = '<div style="color:#c62828;">Error: ' + err.message + '</div>';
      }
    }
    
    // Load Products
    async function loadProducts() {
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '<div style="padding:20px;color:#666;">Loading products...</div>';
      
      if (!supabase) {
        grid.innerHTML = '<div class="muted">Supabase not initialized</div>';
        return;
      }
      
      try {
        const { data, error } = await supabase
          .from('products')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        grid.innerHTML = '';
        if (!data || data.length === 0) {
          grid.innerHTML = '<div class="muted">No products yet.</div>';
          return;
        }
        
        data.forEach(p => {
          const card = document.createElement('div');
          card.className = 'product-card';
          
          card.innerHTML = `
            <img src="${p.image_url || 'https://via.placeholder.com/180/ffe6f0/ff6fb5?text=No+Img'}" 
                 style="width:180px;height:180px;object-fit:cover;border-radius:8px;"/>
            <strong>${escapeHtml(p.name || '')}</strong>
            <div style="font-size:13px;color:#333;">${escapeHtml(p.description || '')}</div>
            <div>RWF ${p.price || 0}</div>
            <div>Stock: ${p.stock || 0}</div>
            <button class="danger" data-id="${p.id}" data-img="${p.image_url || ''}">Delete</button>
          `;
          
          const delBtn = card.querySelector('button');
          delBtn.onclick = async () => {
            if (!confirm('Delete this product?')) return;
            
            const productId = delBtn.getAttribute('data-id');
            const imageUrl = delBtn.getAttribute('data-img');
            
            try {
              if (imageUrl) {
                const path = extractPathFromUrl(imageUrl);
                if (path) {
                  await supabase.storage.from(BUCKET).remove([path]);
                }
              }
              
              const { error: dbErr } = await supabase
                .from('products')
                .delete()
                .eq('id', productId);
              
              if (dbErr) throw dbErr;
              
              showMessage('Product deleted!', 'success');
              loadProducts();
            } catch (err) {
              showMessage('Delete failed: ' + err.message, 'error');
            }
          };
          
          grid.appendChild(card);
        });
      } catch (err) {
        console.error('Load products error:', err);
        grid.innerHTML = '<div class="muted">Error: ' + err.message + '</div>';
      }
    }

    // Robust loadOrders() - drop this in place of your current loadOrders()
async function loadOrders() {
  const container = document.getElementById('ordersList');
  if (!container) return;
  container.innerHTML = '<div style="padding:20px;color:#666;">Loading orders...</div>';

  if (!supabase) {
    container.innerHTML = '<div class="muted">Supabase not initialized</div>';
    return;
  }

  try {
    // Fetch all orders
    const { data: ordersRaw, error: ordErr } = await supabase
      .from('orders')
      .select('*');

    if (ordErr) throw ordErr;
    if (!ordersRaw || ordersRaw.length === 0) {
      container.innerHTML = '<div class="muted" style="padding:12px;color:#666;">No orders yet.</div>';
      return;
    }

    // Gather all unique user_ids and product_ids
    const userIds = Array.from(new Set(ordersRaw.map(o => o.user_id).filter(Boolean)));
    const productIds = Array.from(new Set(ordersRaw.map(o => o.product_id).filter(Boolean)));

    // Fetch related users
    let usersById = {};
    if (userIds.length > 0) {
      const { data: profiles, error: profErr } = await supabase
        .from('profiles')
        .select('id, full_name, email')
        .in('id', userIds);

      if (profErr) console.warn('Failed to fetch profiles:', profErr);
      if (profiles) {
        profiles.forEach(u => {
          usersById[u.id] = u;
        });
      }
    }

    // Fetch related products
    let productsById = {};
    if (productIds.length > 0) {
      const { data: products, error: prodErr } = await supabase
        .from('products')
        .select('id, name, price, image_url');
      if (!prodErr && products) {
        products.forEach(p => {
          productsById[p.id] = p;
        });
      }
    }

    // Sort orders (newest first)
    const orders = ordersRaw.sort((a, b) =>
      new Date(b.created_at) - new Date(a.created_at)
    );

    container.innerHTML = '';

    for (const o of orders) {
      const user = usersById[o.user_id];
      const product = productsById[o.product_id];
      const userName = user?.full_name || 'Unknown User';
      const phoneNumber = user?.phone || 'No phone number registered'
      const prodName = product?.name || 'Unknown Product';
      const img = product?.image_url || 'https://via.placeholder.com/100/ffe6f0/ff6fb5?text=No+Img';
      const created = formatDate(o.created_at);
      const borderColor = o.done_order ? '#2e7d32' : '#ff9800';

      const card = document.createElement('div');
      card.className = 'order-card';
      card.style.cssText = `
        border:2px solid ${borderColor};
        border-radius:8px;
        padding:12px;
        margin-bottom:12px;
        background:#fff;
      `;

      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div>
            <div style="font-weight:700;">Order #${escapeHtml(String(o.id))}</div>
            <div style="font-size:13px;color:#666;">By: ${escapeHtml(userName)} â€¢ ${escapeHtml(created)}</div>
	  <div style="font-size:13px;color:#666;">Phone number: ${escapeHtml(phoneNumber)}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:700;">RWF ${escapeHtml(String(o.amount || 0))}</div>
            <div style="margin-top:6px;">
              <span title="Paid" style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${o.payment_status ? '#2e7d32' : '#ff9800'};margin-right:7px;vertical-align:middle;"></span>
              <span style="font-size:13px;color:#666;margin-right:6px;">Paid</span>
            </div>
            <div style="margin-top:6px;">
              <span title="Done" style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${o.done_order ? '#2e7d32' : '#ff9800'};margin-right:6px;vertical-align:middle;"></span>
              <span style="font-size:13px;color:#666;">Done</span>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:12px;align-items:center;border-top:1px solid #f0f0f0;padding-top:12px;">
          <img src="${img}" alt="${prodName}" style="width:100px;height:100px;object-fit:cover;border-radius:6px;">
          <div style="flex:1;">
            <div style="font-weight:600;">${prodName}</div>
            <div style="font-size:13px;color:#666;margin-top:6px;">Quantity: ${o.quantity}</div>
            <div style="font-size:13px;color:#666;margin-top:6px;">Order amount: RWF ${escapeHtml(String(o.amount || 0))}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button class="danger small" data-action="cancel" data-id="${escapeHtml(String(o.id))}">Cancel</button>
            <button class="primary small" data-action="done" data-id="${escapeHtml(String(o.id))}">${o.done_order ? 'Undo Done' : 'Mark Done'}</button>
          </div>
        </div>
      `;

      // Cancel
      card.querySelector('[data-action="cancel"]').onclick = async () => {
        if (!confirm('Cancel this order?')) return;
        const { error } = await supabase.from('orders').delete().eq('id', o.id);
        if (error) showMessage('Delete failed: ' + error.message, 'error');
        else {
          showMessage('Order cancelled', 'success');
          loadOrders();
        }
      };

      // Mark Done
      card.querySelector('[data-action="done"]').onclick = async () => {
        const newDone = !o.done_order;
        const { error } = await supabase.from('orders').update({ done_order: newDone }).eq('id', o.id);
        if (error) showMessage('Update failed: ' + error.message, 'error');
        else {
          showMessage(`Order ${newDone ? 'marked done' : 'undone'}`, 'success');
          loadOrders();
        }
      };

      container.appendChild(card);
    }

  } catch (err) {
    console.error('Load orders error:', err);
    container.innerHTML = `<div class="muted">Error: ${escapeHtml(err.message || String(err))}</div>`;
  }
}

    
    
    // small helpers
    function escapeHtml(text) {
      const d = document.createElement('div');
      d.textContent = text == null ? '' : String(text);
      return d.innerHTML;
    }
    
    function formatDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      return isNaN(d.getTime()) ? iso : d.toLocaleString();
    }

    
    // Upload Product
    const uploadFileInput = document.getElementById('fileInput');
    const uploadPreview = document.getElementById('previewImg');
    let uploadSelectedFile = null;
    
    uploadFileInput.addEventListener('change', e => {
      const f = e.target.files[0];
      uploadSelectedFile = f || null;
      if (!f) {
        uploadPreview.src = '';
        return;
      }
      uploadPreview.src = URL.createObjectURL(f);
    });
    
    document.getElementById('clearForm').addEventListener('click', () => {
      document.getElementById('prodName').value = '';
      document.getElementById('prodPrice').value = '';
      document.getElementById('prodQty').value = '';
      document.getElementById('prodDesc').value = '';
      uploadFileInput.value = '';
      uploadSelectedFile = null;
      uploadPreview.src = '';
      document.getElementById('uploadStatus').textContent = 'Cleared';
    });
    
    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('prodName').value.trim();
      const price = parseInt(document.getElementById('prodPrice').value || 0, 10);
      const qty = parseInt(document.getElementById('prodQty').value || 0, 10);
      const desc = document.getElementById('prodDesc').value.trim();
      const statusEl = document.getElementById('uploadStatus');
      
      if (!name) {
        alert('Product name required');
        return;
      }
      if (!uploadSelectedFile) {
        alert('Please select an image');
        return;
      }
      
      statusEl.textContent = 'Uploading...';
      
      try {
        if (!supabase) throw new Error('Supabase not initialized');
        
        const { data: userData, error: userErr } = await supabase.auth.getUser();
        if (userErr || !userData.user) {
          alert('You must be signed in');
          statusEl.textContent = 'Auth required';
          return;
        }
        
        const user = userData.user;
        const file = uploadSelectedFile;
        const ext = (file.name || '').split('.').pop();
        const fileName = `prod_${Date.now()}.${ext || 'png'}`;
        
        statusEl.textContent = 'Uploading image...';
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from(BUCKET)
          .upload(fileName, file, { contentType: file.type, upsert: false });
        
        if (uploadError) {
          statusEl.textContent = 'Upload failed: ' + uploadError.message;
          return;
        }
        
        const pubRes = supabase.storage.from(BUCKET).getPublicUrl(fileName);
        const publicUrl = pubRes?.data?.publicUrl || pubRes?.publicURL || null;
        
        statusEl.textContent = 'Saving to database...';
        const { data: insertData, error: insertErr } = await supabase
          .from('products')
          .insert([{
            name,
            price,
            stock: qty,
            description: desc,
            image_url: publicUrl,
            owner: user.id
          }]);
        
        if (insertErr) {
          statusEl.textContent = 'Database error: ' + insertErr.message;
          await supabase.storage.from(BUCKET).remove([fileName]);
          return;
        }
        
        statusEl.textContent = 'Product added successfully!';
        showMessage('Product added!', 'success');
        document.getElementById('clearForm').click();
        
        if (document.getElementById('tab-products').classList.contains('active')) {
          loadProducts();
        }
        
      } catch (err) {
        console.error('Upload error:', err);
        statusEl.textContent = 'Error: ' + err.message;
      }
    });
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        if (supabase) await supabase.auth.signOut();
      } catch (e) {
        console.warn('Signout error:', e);
      }
      window.location.href = 'index.html';
    });
  </script>
</body>
</html>
