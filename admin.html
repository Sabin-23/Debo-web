<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link rel="stylesheet" href="stylesad.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { display:flex; margin:0; font-family:sans-serif; background:pink; }
nav { width:220px; background:#f06292; color:white; padding:20px; box-sizing:border-box; }
nav h2 { margin-top:0; }
nav ul { list-style:none; padding:0; }
nav li { margin:10px 0; cursor:pointer; }
nav li:hover { text-decoration:underline; }
main { flex:1; padding:20px; box-sizing:border-box; overflow:auto; }
.tab { display:none; }
.product-card { display:inline-block; border:1px solid #ccc; padding:10px; margin:10px; background:white; }
.product-card img { display:block; margin-bottom:5px; }
.button { margin:5px 0; cursor:pointer; }
</style>
</head>
<body>

<nav>
<h2>Admin</h2>
<ul>
<li onclick="showTab('orders')">Orders</li>
<li onclick="showTab('upload')">Upload Product</li>
<li onclick="showTab('analysis')">Analysis</li>
<li onclick="showTab('users')">Users</li>
<li onclick="showTab('allProducts')">All Products</li>
<li onclick="showTab('messages')">Messages</li>
<li onclick="logout()">Logout</li>
</ul>
</nav>

<main>
<!-- ORDERS TAB -->
<div id="orders" class="tab">
<h2>Orders</h2>
<div id="ordersGrid"></div>
</div>

<!-- UPLOAD PRODUCT TAB -->
<div id="upload" class="tab">
<h2>Upload New Product</h2>
<form id="productForm">
<input type="text" id="name" placeholder="Product name" required><br>
<input type="number" id="price" placeholder="Price (RWF)" required><br>
<textarea id="description" placeholder="Product description"></textarea><br>
<input type="number" id="quantity" placeholder="Quantity in stock" required><br>
<input type="file" id="file" accept="image/*" required><br>
<button type="submit">Add Product</button>
</form>
<div id="status"></div>
</div>

<!-- ANALYSIS TAB -->
<div id="analysis" class="tab">
<h2>Analysis</h2>
<table border="1" cellpadding="5">
<thead><tr><th>User</th><th>Visits</th><th>Orders</th><th>Total Quantity</th><th>Total Money</th></tr></thead>
<tbody id="analysisTable"></tbody>
</table>
</div>

<!-- USERS TAB -->
<div id="users" class="tab">
<h2>Users</h2>
<table border="1" cellpadding="5">
<thead><tr><th>Full Name</th><th>Email</th><th>Phone</th><th>Admin</th><th>Created At</th></tr></thead>
<tbody id="usersTable"></tbody>
</table>
</div>

<!-- ALL PRODUCTS TAB -->
<div id="allProducts" class="tab">
<h2>All Products</h2>
<div id="productsGrid"></div>
</div>

<!-- MESSAGES TAB -->
<div id="messages" class="tab">
<h2>Messages</h2>
<div id="messagesGrid"></div>
</div>

</main>

<script>
const supabaseUrl = "https://hlskxkqwymuxcjgswqnv.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhsc2t4a3F3eW11eGNqZ3N3cW52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzQ1ODIsImV4cCI6MjA3MzAxMDU4Mn0.NdGjbd7Y1QorTF5BIqAduItcvbh1OdP1Y2qNYf0pILw";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

function showTab(tabId) {
  document.querySelectorAll('.tab').forEach(t => t.style.display='none');
  document.getElementById(tabId).style.display='block';
  if(tabId==='allProducts') displayProducts();
  if(tabId==='orders') displayOrders();
  if(tabId==='users') displayUsers();
  if(tabId==='messages') displayMessages();
  if(tabId==='analysis') displayAnalysis();
}

// ======================= LOGOUT =======================
function logout() {
  supabase.auth.signOut();
  alert('Logged out');
  // optionally reload page
  location.reload();
}

// ======================= UPLOAD PRODUCT =======================
const form = document.getElementById("productForm");
const fileInput = document.getElementById("file");
const status = document.getElementById("status");

form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name = document.getElementById("name").value;
  const price = parseFloat(document.getElementById("price").value);
  const description = document.getElementById("description").value;
  const quantity = parseInt(document.getElementById("quantity").value);

  if(!fileInput.files.length){ alert("Select image"); return; }
  const file = fileInput.files[0];
  const fileExt = file.name.split(".").pop();
  const fileName = `${Date.now()}.${fileExt}`;
  const filePath = `product-images/${fileName}`;

  status.textContent="Uploading image...";

  const { data: uploadData, error: uploadError } = await supabase.storage
    .from("product-images").upload(filePath, file, {upsert:true});
  if(uploadError){ status.textContent="Upload failed: "+uploadError.message; return; }

  const { data: publicData } = supabase.storage.from("product-images").getPublicUrl(filePath);
  const imageUrl = publicData.publicUrl;

  const { data, error } = await supabase.from("products")
    .insert([{ name, price, description, quantity, image_url:imageUrl }]);
  if(error){ status.textContent="Insert failed: "+error.message; return; }

  status.textContent="Product added!";
  form.reset();
  displayProducts();
});

// ======================= DISPLAY PRODUCTS =======================
const productsGrid = document.getElementById("productsGrid");

async function displayProducts(){
  const { data: products, error } = await supabase.from("products").select("*");
  if(error){ productsGrid.innerHTML="Error: "+error.message; return; }

  productsGrid.innerHTML = products.map(p=>`
    <div class="product-card">
      <img src="${p.image_url}" width="150">
      <h3>${p.name}</h3>
      <p>${p.description||''}</p>
      <p>Price: ${p.price} RWF</p>
      <p>Quantity: ${p.quantity}</p>
      <input type="file" id="file-${p.id}" accept="image/*">
      <button class="button" onclick="changeProductImage('${p.id}')">Update Image</button>
      <button class="button" onclick="deleteProduct('${p.id}','${p.image_url}')">Delete Product</button>
    </div>
  `).join('');
}

// ======================= CHANGE IMAGE =======================
async function changeProductImage(productId){
  const fileInput = document.getElementById(`file-${productId}`);
  if(!fileInput.files.length){ alert("Select image"); return; }
  const file = fileInput.files[0];
  const fileExt = file.name.split(".").pop();
  const fileName = `${Date.now()}.${fileExt}`;
  const filePath = `product-images/${fileName}`;

  const { data: uploadData, error: uploadError } = await supabase.storage
    .from("product-images").upload(filePath, file, {upsert:true});
  if(uploadError){ alert("Upload failed: "+uploadError.message); return; }

  const { data: publicData } = supabase.storage.from("product-images").getPublicUrl(filePath);
  const imageUrl = publicData.publicUrl;

  // get old image
  const { data: product } = await supabase.from("products").select("image_url").eq("id",productId).single();
  const oldImageUrl = product.image_url;

  const { error: updateError } = await supabase.from("products").update({image_url:imageUrl}).eq("id",productId);
  if(updateError){ alert("Update failed: "+updateError.message); return; }

  if(oldImageUrl){
    const path = oldImageUrl.split("/storage/v1/object/public/")[1];
    await supabase.storage.from("product-images").remove([path]);
  }

  displayProducts();
}

// ======================= DELETE PRODUCT =======================
async function deleteProduct(productId, imageUrl){
  if(!confirm("Delete this product?")) return;
  const { error } = await supabase.from("products").delete().eq("id",productId);
  if(error){ alert("Delete failed: "+error.message); return; }

  if(imageUrl){
    const path = imageUrl.split("/storage/v1/object/public/")[1];
    await supabase.storage.from("product-images").remove([path]);
  }

  displayProducts();
}

// ======================= ORDERS =======================
const ordersGrid = document.getElementById("ordersGrid");
async function displayOrders(){
  const { data: orders, error } = await supabase.from("orders").select("*,products(*),profiles(*)");
  if(error){ ordersGrid.innerHTML="Error: "+error.message; return; }

  ordersGrid.innerHTML = orders.map(o=>`
    <div style="border:1px solid #ccc; padding:10px; margin:5px; background:white;">
      <img src="${o.products?.image_url||''}" width="100">
      <strong>${o.products?.name}</strong><br>
      User: ${o.profiles?.full_name || 'Guest'}<br>
      Phone: ${o.profiles?.phone||''}<br>
      Location: ${o.location || ''}<br>
      Quantity: ${o.quantity}<br>
      Amount: ${o.amount}<br>
      Payment: <span style="color:${o.payment_status?'green':'orange'};">‚óè</span>
    </div>
  `).join('');
}

// ======================= USERS =======================
const usersTable = document.getElementById("usersTable");
async function displayUsers(){
  const { data: users, error } = await supabase.from("profiles").select("*");
  if(error){ usersTable.innerHTML="Error: "+error.message; return; }
  usersTable.innerHTML = users.map(u=>`
    <tr>
      <td>${u.full_name}</td>
      <td>${u.email}</td>
      <td>${u.phone}</td>
      <td>${u.is_admin}</td>
      <td>${u.created_at}</td>
    </tr>
  `).join('');
}

// ======================= MESSAGES =======================
const messagesGrid = document.getElementById("messagesGrid");
async function displayMessages(){
  const { data: messages, error } = await supabase.from("messages").select("*");
  if(error){ messagesGrid.innerHTML="Error: "+error.message; return; }
  messagesGrid.innerHTML = messages.map(m=>`
    <div style="border:1px solid #ccc; padding:10px; margin:5px; background:white;">
      <strong>${m.name}</strong> (${m.email})<br>
      ${m.message}
    </div>
  `).join('');
}

// ======================= ANALYSIS =======================
const analysisTable = document.getElementById("analysisTable");
async function displayAnalysis(){
  const { data: users, error: usersErr } = await supabase.from("profiles").select("*");
  if(usersErr){ analysisTable.innerHTML="Error"; return; }
  const { data: orders, error: ordersErr } = await supabase.from("orders").select("*");
  if(ordersErr){ analysisTable.innerHTML="Error"; return; }

  const rows = users.map(u=>{
    const userOrders = orders.filter(o=>o.user_id === u.id);
    const totalQty = userOrders.reduce((a,b)=>a+b.quantity,0);
    const totalMoney = userOrders.reduce((a,b)=>a+b.amount,0);
    return `<tr>
      <td>${u.full_name}</td>
      <td>${u.visits||0}</td>
      <td>${userOrders.length}</td>
      <td>${totalQty}</td>
      <td>${totalMoney}</td>
    </tr>`;
  });

  // Guest row
  const guestOrders = orders.filter(o=>o.user_id===null);
  const guestQty = guestOrders.reduce((a,b)=>a+b.quantity,0);
  const guestMoney = guestOrders.reduce((a,b)=>a+b.amount,0);
  rows.push(`<tr>
    <td>Guest</td>
    <td>0</td>
    <td>${guestOrders.length}</td>
    <td>${guestQty}</td>
    <td>${guestMoney}</td>
  </tr>`);

  analysisTable.innerHTML = rows.join('');
}

// show default tab
showTab('orders');

</script>
</body>
</html>
